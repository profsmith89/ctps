

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Chapter 5: Play Guess-a-number &#8212; Computational Thinking and Problem Solving</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/myfile.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chap05';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Chapter 6: Do You See My Dog?" href="chap06.html" />
    <link rel="prev" title="Chapter 4: Query a Web Resource" href="chap04.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="ctps.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/mike_flat.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/mike_flat.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="ctps.html">
                    <no title>
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="welcome.html">Welcome</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap01.html">Chapter 1: Read a Children’s Book</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap02.html">Chapter 2: Grab the Dialogue</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap03.html">Chapter 3: Replace Text with Emoji</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap04.html">Chapter 4: Query a Web Resource</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Chapter 5: Play Guess-a-number</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap06.html">Chapter 6: Do You See My Dog?</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap07.html">Chapter 7: Many But Not Any Number</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap08.html">Chapter 8: What Is My Problem?</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap09.html">Chapter 9: Find a Phrase</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap10.html">Chapter 10: Build an Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap11.html">Chapter 11: Discover Driving Directions</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap12.html">Chapter 12: Divide and Conquer</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap13.html">Chapter 13: Rewrite the Error Message</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap14.html">Chapter 14: The Dream of Bug Fixing</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap15.html">Chapter 15: Embrace Runtime Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap16.html">Chapter 16: Catch Them Early</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap17.html">Chapter 17: Build Prediction Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="chap18.html">Chapter 18: Use Generative AI</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/chap05.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Chapter 5: Play Guess-a-number</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#guessing-a-number">Guessing a number</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-player-s-guess">The player’s guess</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#type-conversion">Type conversion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#try-and-recover">Try and recover</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-game-loop">The game loop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-our-proposed-solution">Testing our proposed solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-networked-architecture">A networked architecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#its-sequence-diagram">Its sequence diagram</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-a-new-library">When to use a new library</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sockets-in-action">Sockets in action</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#specifying-the-other-party">Specifying the other party</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sending-and-receiving-messages">Sending and receiving messages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#size-matters">Size matters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-again">Encoding again!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simplified-networking-interface">A simplified networking interface</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-server">The server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-connection">A connection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#picking-up-a-call">Picking up a call</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-conversation">The conversation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#programmer-beware">Programmer beware</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-it">Run it!</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="chapter-5-play-guess-a-number">
<h1>Chapter 5: Play Guess-a-number<a class="headerlink" href="#chapter-5-play-guess-a-number" title="Permalink to this heading">#</a></h1>
<p>You have learned to write client applications for the client-server model, and although we have seen how powerful this can be, we’d like to understand (and be able to code) both sides of this model. To bring in the server side, we are going to focus on networked scripts that allow us to connect a human on one computer with a human on another. In particular, we will demonstrate this capability through the development of a networked game.</p>
<p>Games are useful platforms for learning for two simple reasons: (1) they typically have a well-defined set of legal actions and a clear goal, which constrains the amount of functionality we need implement; and (2) they can be, simultaneously, fun to play and difficult to test.</p>
<p>The class of difficult-to-test games that we’ll build are those involving some aspect of randomness. Learning to write a stochastic program allows us to solve an amazingly wide range of problems. Debugging and testing a script with nondeterminism, however, can be a challenge, and our network game example will teach you some ways to deal with that challenge.<a class="footnote-reference brackets" href="#fn1" id="id1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a></p>
<p>Since we’ve learned to start with an easy instance of our problem-to-be-solved, we are going to build toward a networked game. We’ll first build a simple game involving randomness that runs on our computers and requires only a single person to play. We will then add a networking component. Are you ready to build something educational and fun?</p>
<div class="admonition-learning-outcomes admonition">
<p class="admonition-title">Learning Outcomes</p>
<p>This chapter moves away from our work with children’s books and focuses on building children’s games. Games typically have a well-defined set of legal actions and a clear goal, which simplifies the first two steps in our problem-solving process (i.e., the need to precisely specify the problem and imagine specific instances of it). This allows you to spend more time on the last six steps, and using the knowledge you’ve gained in the previous chapters, you are now ready to practice these steps on your own. You may find it hard to apply what you’ve learned and you’ll undoubtedly make mistakes, but with practice will come competency.</p>
<p>To successfully solve a complex problem, you need to learn to scaffold. This chapter begins with the design of a simple, single-person game that you can run on your machine, and it ends with a networked version, where you build both the client and server. After this journey, you will be able to:</p>
<ul class="simple">
<li><p>Employ randomness in game design and test such unpredictable programs [design and programming skills];</p></li>
<li><p>Think about the turn and game-loop structure of game scripts [design];</p></li>
<li><p>Describe the purpose of type conversion and know when to use it [CS concepts and programming skills];</p></li>
<li><p>Understand the importance of input checking and failing gracefully, and recognize a couple of different error-handling patterns, including Python’s try-except-statement [design and programming skills];</p></li>
<li><p>Split a non-networked script into a portion run on a client and the rest on a server [design];</p></li>
<li><p>Draw sequence diagrams and use them to map out the sequence of network messages that will allow the client and server to accomplish a task [design];</p></li>
<li><p>Evaluate the pros and cons of using libraries with similar functionality [design and programming skills];</p></li>
<li><p>Explain the purpose of sockets in network programming and how to use them to create networked applications [CS concepts and programming skills];</p></li>
<li><p>Write and run a client and server that can communicate by interprocess communication using sockets [design, CS concepts, and programming skills];</p></li>
<li><p>Understand what it means to talk about a hostname, software ports, IP addresses, and specialized addresses like the loopback address [CS concepts];</p></li>
<li><p>Discuss the purpose of a shim library [design and CS concepts].</p></li>
</ul>
</div>
<section id="guessing-a-number">
<p><strong>Guessing a number.</strong> Let’s build an extremely simple game involving randomness. This game will have the computer “think” of a number between 1 and 100, and then we will try to guess it.</p>
<p>The core of this game is generating a secret number, and if we can figure out how to do that in Python, we can probably build the rest of the game based on stuff we’ve already learned (i.e., using loops and conditionals). Given our recent mentions about randomness, you’ve probably guessed that having a computer “think” of a number means that it should randomly select one within a given range. As we have experienced lately, the Python library often has exactly the functionality we need, and it is true once again. We simply need to import the <code class="docutils literal notranslate"><span class="pre">random</span></code> library<a class="footnote-reference brackets" href="#fn2" id="id2" role="doc-noteref"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></a> and invoke its <code class="docutils literal notranslate"><span class="pre">randint</span></code> function, specifying the range we desire.</p>
<div class="admonition-you-try-it admonition">
<p class="admonition-title">You Try It</p>
<p>Run the following code block and try changing the parameters to the <code class="docutils literal notranslate"><span class="pre">randint</span></code> function. You should eventually move the <code class="docutils literal notranslate"><span class="pre">import</span></code> and <code class="docutils literal notranslate"><span class="pre">randint</span></code> statements into <code class="docutils literal notranslate"><span class="pre">guess.py</span></code>, where you’ll build our game.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="c1">### chap05/guess.py</span>
<span class="linenos">2</span><span class="kn">import</span> <span class="nn">random</span> 
<span class="linenos">3</span>
<span class="linenos">4</span><span class="n">secret</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="linenos">5</span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;The secret number is </span><span class="si">{</span><span class="n">secret</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now that our computer can generate a secret number, we are ready to begin building the game. We can start <em>inside-out</em> or <em>outside-in</em>, which means deciding whether you think first about what takes place in a single game turn (i.e., inside-out) or by thinking about the overall structure of the game (i.e., outside-in).  For this example, let’s begin with what takes place in a single game turn.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It doesn’t matter whether you approach a problem inside-out or outside-in. Do whichever makes you most comfortable, or which seems to like the fastest way to get started.</p>
</div>
<p>In any single turn of this simple game, the player makes a guess and the computer checks this guess against its secret number. We might write down this idea using the following pseudocode:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 9</span><span class="c1"># Grab the player&#39;s guess</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="c1"># Check guess against the secret</span>
</pre></div>
</div>
<p>Is this all we need to do in a turn? No, this game wouldn’t be much fun if we didn’t let the player know the result of our comparison. Let’s fix that as we convert the pseudocode into Python.</p>
<div class="admonition-you-try-it admonition">
<p class="admonition-title">You Try It</p>
<p>Don’t peek at the next code block and try to write Python statements that implement line 11 in the previous code block. Make sure to print what you learn from your checks! You’ve seen, in previous chapters, all the Python that’s required.</p>
</div>
<p>To push the answer down a bit, I’ll take a moment to explain that I’ve tried to make as many of this chapter’s code blocks runnable without errors as possible, but you should be aware of a few things:</p>
<ol class="arabic simple">
<li><p>Not every combination of pseudocode and Python code makes sense to run. For example, I sometimes use a variable name before I’ve converted the pseudocode that defines that variable name (e.g., in the next code block where it checks <code class="docutils literal notranslate"><span class="pre">guess</span></code> before I’ve written the code that defines it). Other times, a code block contains only part of a script. The text doesn’t call out such cases as I assume you can recognize them.</p></li>
<li><p>More often, a code block fails because I’m demonstrating a common error (e.g., the need for a type conversion, as I illustrate in our first attempt to grab a player’s guess). I explicitly call these instances out in the text.</p></li>
<li><p>Toward the middle of the chapter we begin writing client and server scripts, and you should know that it doesn’t make much sense to run a client script without the server script also running—they need to communicate! Don’t attempt to run any of the individual client and server scripts. This chapter’s final section titled “Run it!” provides you with instructions on how to run client and server scripts together.</p></li>
</ol>
<p>And now a set of Python statements that implement the pseudocode in line 11 above. It doesn’t matter which two conditions you check and in what order as long as you handle all three.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 9</span><span class="c1"># Grab the player&#39;s guess</span>
<span class="linenos">10</span>
<span class="linenos">11</span><span class="c1"># Check guess against the secret</span>
<span class="linenos">12</span><span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">13</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too small!&#39;</span><span class="p">)</span>
<span class="linenos">14</span><span class="k">elif</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">15</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">)</span>
<span class="linenos">16</span><span class="k">else</span><span class="p">:</span>
<span class="linenos">17</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too big!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="the-player-s-guess">
<p><strong>The player’s guess.</strong> Good work! Now, how do we grab the player’s guess? To this point, we’ve learned how to take input directly from a user, from a file, from the script’s command line, and from a network resource. Which is appropriate for this problem?</p>
<p>Given that we’d like to build an interactive game, the first option is probably the most appropriate, and this means we’ll use Python’s built-in function <code class="docutils literal notranslate"><span class="pre">input</span></code> to grab something directly from the user. Like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 9</span><span class="c1"># Grab the player&#39;s guess</span>
<span class="linenos">10</span><span class="n">guess</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">)</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="c1"># Check guess against the secret</span>
<span class="linenos">13</span><span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">14</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too small!&#39;</span><span class="p">)</span>
<span class="linenos">15</span><span class="k">elif</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">16</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">)</span>
<span class="linenos">17</span><span class="k">else</span><span class="p">:</span>
<span class="linenos">18</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too big!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Run the earlier code block that defined <code class="docutils literal notranslate"><span class="pre">secret</span></code> and then the code block above (or run <code class="docutils literal notranslate"><span class="pre">guess.py</span></code> where you’ve placed these two code blocks). You’ll find that the comparison between <code class="docutils literal notranslate"><span class="pre">guess</span></code> and <code class="docutils literal notranslate"><span class="pre">secret</span></code> fails with a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code>.</p>
<p>If you review the documentation for <code class="docutils literal notranslate"><span class="pre">input</span></code><a class="footnote-reference brackets" href="#fn3" id="id3" role="doc-noteref"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></a> you’ll read that this function takes everything on the line typed by the player, except for the trailing newline character, and converts it to a string object. This means that our if-statements asked the Python interpreter to compare a string object (<code class="docutils literal notranslate"><span class="pre">guess</span></code>) against an integer object (<code class="docutils literal notranslate"><span class="pre">secret</span></code>). Such a comparison raises a <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> exception because it makes no sense to compare these two things. The Python interpreter has no idea what you want it to do.</p>
<p>No big deal. We simply need to convert something like <code class="docutils literal notranslate"><span class="pre">'42'</span></code> into <code class="docutils literal notranslate"><span class="pre">42</span></code>. The first is a string representation of a number, but the interpreter doesn’t know that. It simply knows that <code class="docutils literal notranslate"><span class="pre">'42'</span></code> is a string of characters.</p>
<p>We can convert a string representing a number into an integer using Python’s built-in function <code class="docutils literal notranslate"><span class="pre">int</span></code>. We don’t need the string returned by <code class="docutils literal notranslate"><span class="pre">input</span></code> for any reason other than passing it to <code class="docutils literal notranslate"><span class="pre">int</span></code>, and so let’s pass it directly. The following code block does this, and it executes without an error.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 9</span><span class="c1"># Grab the player&#39;s guess</span>
<span class="linenos">10</span><span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">))</span>
<span class="linenos">11</span>
<span class="linenos">12</span><span class="c1"># Check guess against the secret</span>
<span class="linenos">13</span><span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">14</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too small!&#39;</span><span class="p">)</span>
<span class="linenos">15</span><span class="k">elif</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">16</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">)</span>
<span class="linenos">17</span><span class="k">else</span><span class="p">:</span>
<span class="linenos">18</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too big!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="type-conversion">
<p><strong>Type conversion.</strong> What we have just done is known as <em>type conversion</em>. Type information helps the interpreter to know how it should interpret the bag of stuff you gave it and, if you instructed the interpreter to do something with this bag of stuff, manipulate it. What do I mean by “bag of stuff”? In the next chapter, we’ll learn how computers exactly represent an object like an <code class="docutils literal notranslate"><span class="pre">int</span></code> and a <code class="docutils literal notranslate"><span class="pre">str</span></code>, but for now, we can use an analogy.</p>
<p>My dog and I are both living beings that can be thought of as a “bag of stuff,” i.e., collection of biological cells or molecules or atoms). We’ll soon learn that <code class="docutils literal notranslate"><span class="pre">'42'</span></code> and <code class="docutils literal notranslate"><span class="pre">42</span></code> are both a collection of <em>bits</em>. This is what people mean when they describe the physical world as the world of atoms and the digital world as the world of bits.</p>
<p>While my dog and I are both a bag of cells, interesting things can happen in our world if my bag of cells is labeled with the type <code class="docutils literal notranslate"><span class="pre">man</span></code> and my dog’s bag of cells is labeled with the type <code class="docutils literal notranslate"><span class="pre">dog</span></code>. With my type label, I can, for example, enter a restaurant and order some food because the restaurant serves bags of cells with my type. The restaurant, on the other hand, would shoo the bag of cells that is my dog out the door because of its type label.</p>
<p>Why doesn’t the Python interpreter allow us to compare a string to an integer even though both are a bag of bits? The interpreter looks at the type information and uses this information to decide if the two objects are comparable. Two integers are comparable, as we learned in math. We can also compare two strings to determine their alphabetical order. But the interpreter doesn’t know what to do if you ask it to compare a string and an integer because no one has defined what it means to compare objects of these different types.</p>
<p>This brings us to the concept of type conversion. Sometimes two bags of stuff have different types, but they represent the same idea. When this is true, we can successfully perform a type conversion. A dog and a man in a dog suit have two different types (<code class="docutils literal notranslate"><span class="pre">dog</span></code> and <code class="docutils literal notranslate"><span class="pre">man</span></code>), but they represent the same idea (dog). The same thing happens with <code class="docutils literal notranslate"><span class="pre">42</span></code> and <code class="docutils literal notranslate"><span class="pre">'42'</span></code>. The string <code class="docutils literal notranslate"><span class="pre">'42'</span></code> is a string in an integer suit. It’s not the integer <code class="docutils literal notranslate"><span class="pre">42</span></code>, but we know that it represents the idea of the number 42.</p>
</section>
<section id="try-and-recover">
<p><strong>Try and recover.</strong> Of course, not every string value is a string in an integer suit. What happens if the player types <code class="docutils literal notranslate"><span class="pre">garbage</span></code> at our input prompt? Well, <code class="docutils literal notranslate"><span class="pre">input</span></code> will return a string object with the value <code class="docutils literal notranslate"><span class="pre">'garbage'</span></code> and this object will be passed to <code class="docutils literal notranslate"><span class="pre">int</span></code>, which will try unsuccessfully to convert it into an integer value. This unsuccessful attempt will generate a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> exception and end our script.</p>
<p>Perhaps that’s a fine action for a player silly enough to type <code class="docutils literal notranslate"><span class="pre">garbage</span></code> when we asked them for a number, but is that what we want to happen if the player simply mistypes their input? Perhaps I mean to type <code class="docutils literal notranslate"><span class="pre">42</span></code>, but on my way to the return key, I mistakenly swipe the apostrophe key and actually input <code class="docutils literal notranslate"><span class="pre">42'</span></code>. Could we make our script a bit more resilient?</p>
<p>This is the purpose of Python’s <code class="docutils literal notranslate"><span class="pre">try-except</span></code> compound statement. If we wrap our type conversion inside one of these statements, our script can catch the <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> exception before it terminates our running script. Once caught, we can try and recover from the unsuccessful action. A good way to recover is to wrap the try-except-statement in an infinite loop, which continually asks the player for a guess until they submit a guess that is an actual integer. Here then is the final code for our line of pseudocode saying we should grab the player’s guess.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 9</span><span class="c1"># Grab the player&#39;s guess</span>
<span class="linenos">10</span><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">11</span>    <span class="k">try</span><span class="p">:</span>
<span class="linenos">12</span>        <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">))</span>
<span class="linenos">13</span>        <span class="k">break</span>
<span class="linenos">14</span>    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="linenos">15</span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Guesses must be an integer. Try again...&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>How does this new statement work? There are two cases to consider:</p>
<ol class="arabic simple">
<li><p>If <code class="docutils literal notranslate"><span class="pre">int</span></code> is successful in converting the result of <code class="docutils literal notranslate"><span class="pre">input</span></code>, the interpreter operates as if the try-except-statement was never there. It makes it to the break-statement and exits the infinite loop.</p></li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">int</span></code> is unsuccessful and raises a <code class="docutils literal notranslate"><span class="pre">ValueError</span></code> exception, the exception doesn’t terminate our script but redirects the interpreter to the code inside the except-clause, which prints a helpful message. Once this is done, we fall out of the try-except-statement and continues with the next iteration of the while-loop.</p></li>
</ol>
<p>Any statement within the try-block that raises an exception listed in the except-block will redirect the interpreter to the except-block. In later problems, we’ll change the kind of exception that our except-block catches.</p>
<p>By catching exceptions like this, we save ourselves some difficult coding work<a class="footnote-reference brackets" href="#fn4" id="id4" role="doc-noteref"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></a> and create a program that <em>fails gracefully</em>. This phrase means that our script is: (1) resilient to poorly structured inputs; (2) able to give the user more than one attempt at making the input well-structured; and (3) more helpful than a typical Python exception message in telling the user what went wrong.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You <em>never</em> want to trust that the user provided your script with well-structured input. You should <em>always</em> have your script check that the user input is what you expect it to be. This is the first step in writing scripts with strong security guarantees. A try-except-statement wrapped in an infinite loop is just one design pattern that accomplishes this.</p>
</div>
</section>
<section id="the-game-loop">
<p><strong>The game loop.</strong> We started building our game from the inside-out, and now we must think about the relationship between a single turn of the game to the entire game. Well, the game is not over until the player guesses the secret number and the computer prints: <code class="docutils literal notranslate"><span class="pre">Exactly!</span> <span class="pre">You</span> <span class="pre">win!</span></code> If we want the player to make multiple guesses, we must wrap our logic for a single turn inside another loop. Let’s make it an infinite loop, since we don’t know how many attempts the player will need to finally guess the secret number. Here is the game all together, with a few debugging <code class="docutils literal notranslate"><span class="pre">print</span></code> statements currently commented out.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">### chap5/guess32.py</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 5</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;## Welcome to GUESS THE NUMBER! ##&#39;</span><span class="p">)</span>
<span class="linenos"> 6</span>    
<span class="linenos"> 7</span>    <span class="n">secret</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="linenos"> 8</span>    <span class="c1"># print(f&#39;DEBUG: The secret number is {secret}&#39;)</span>
<span class="linenos"> 9</span>    
<span class="linenos">10</span>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># our game loop</span>
<span class="linenos">11</span>        
<span class="linenos">12</span>        <span class="c1"># Grab a guess from the player</span>
<span class="linenos">13</span>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">14</span>            <span class="k">try</span><span class="p">:</span>
<span class="linenos">15</span>                <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">))</span>
<span class="linenos">16</span>                <span class="k">break</span>
<span class="linenos">17</span>            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="linenos">18</span>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Guesses must be an integer. Try again...&#39;</span><span class="p">)</span>
<span class="linenos">19</span>        <span class="c1"># print(f&#39;DEBUG: You guessed {guess}&#39;)</span>
<span class="linenos">20</span>        
<span class="linenos">21</span>        <span class="c1"># Check guess against the secret</span>
<span class="linenos">22</span>        <span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">23</span>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too small!&#39;</span><span class="p">)</span>
<span class="linenos">24</span>        <span class="k">elif</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">25</span>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">)</span>
<span class="linenos">26</span>            <span class="k">break</span>
<span class="linenos">27</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">28</span>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too big!&#39;</span><span class="p">)</span>
<span class="linenos">29</span>
<span class="linenos">30</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">31</span>    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="testing-our-proposed-solution">
<p><strong>Testing our proposed solution.</strong> We have a solution, but how do we know if it works correctly? As we learned in earlier problems, we could run it with a range of inputs that together test the different sequences of statements (also called <em>code paths</em>) in our script. In particular, we’ll want to input integers and some garbage to test our grab-a-player’s-guess loop, and we’ll want to exercise each of the branches of the if-statement that compares the <code class="docutils literal notranslate"><span class="pre">guess</span></code> and the <code class="docutils literal notranslate"><span class="pre">secret</span></code>.</p>
<p>But how, for example, can we input a guess that’s bigger than the secret if we don’t know the secret? The answer is simple: We remove the randomness while testing. This is the purpose of the print-statements in the script that are currently commented out. Removing the comment character allows us to see the secret and input an appropriate guess to test a selected code path. We may also want to print <code class="docutils literal notranslate"><span class="pre">guess</span></code> to reassure ourselves that the script is working with the value it should have grabbed.</p>
<div class="admonition-you-try-it admonition">
<p class="admonition-title">You Try It</p>
<p>Run some tests on <code class="docutils literal notranslate"><span class="pre">guess32.py</span></code>. Make sure you believe it works as expected.</p>
</div>
</section>
<section id="a-networked-architecture">
<p><strong>A networked architecture.</strong> Now that we understand the logic involved in a single-player game and have a working script for it, we can think about splitting this script’s operation across a client script and a server script.</p>
<p>What does that exactly mean? It means that the client and server scripts will work together to generate the exact same user experience as we achieved with <code class="docutils literal notranslate"><span class="pre">guess32.py</span></code>. However, some part of the game will be running not on our machine, but some other machine elsewhere on the Internet.</p>
<p>Typically, we think of the player as sitting at a client, and if that’s true, what might make sense to have run elsewhere? How about the generation of the secret number and the comparison of our guess against that secret. When those things are happening directly on our machine, it might be tempting to cheat and dig through our computer’s memory looking for the secret. If we put it physically elsewhere, it would make it much harder for us to cheat.</p>
<p>Let’s consider each statement in <code class="docutils literal notranslate"><span class="pre">guess32.py</span></code> and decide where to place them: in the client (C) script; or in the server (S) script. Extracting the non-comment statements in the <code class="docutils literal notranslate"><span class="pre">main</span></code> function, I’ve begun this exercise by placing an <code class="docutils literal notranslate"><span class="pre">S</span></code> in front of the line numbers corresponding to the generation of the secret (line 3) and the checking of the guess against the secret (lines 14-20). Any statements involving or dependent upon the secret should execute on the server.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>   <span class="mi">1</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;## Welcome to GUESS THE NUMBER! ##&#39;</span><span class="p">)</span>
   <span class="mi">2</span>
<span class="n">S</span>  <span class="mi">3</span>  <span class="n">secret</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
   <span class="mi">4</span>
   <span class="mi">5</span>  <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># our game loop</span>
   <span class="mi">6</span>
   <span class="mi">7</span>      <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
   <span class="mi">8</span>          <span class="k">try</span><span class="p">:</span>
   <span class="mi">9</span>              <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">))</span>
  <span class="mi">10</span>              <span class="k">break</span>
  <span class="mi">11</span>          <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
  <span class="mi">12</span>              <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Guesses must be an integer. Try again...&#39;</span><span class="p">)</span>
  <span class="mi">13</span>
<span class="n">S</span> <span class="mi">14</span>      <span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">secret</span><span class="p">:</span>
<span class="n">S</span> <span class="mi">15</span>          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too small!&#39;</span><span class="p">)</span>
<span class="n">S</span> <span class="mi">16</span>      <span class="k">elif</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
<span class="n">S</span> <span class="mi">17</span>          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">)</span>
  <span class="mi">18</span>          <span class="k">break</span>
<span class="n">S</span> <span class="mi">19</span>      <span class="k">else</span><span class="p">:</span>
<span class="n">S</span> <span class="mi">20</span>          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too big!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>I left an <code class="docutils literal notranslate"><span class="pre">S</span></code> off line 18 because that’s a piece of functionality we want to make sure that we run on the client. The <code class="docutils literal notranslate"><span class="pre">break</span></code> effectively says that the game is over, and when this is true, we want the client script to exit.</p>
<p>Let’s look at the rest of the unmarked statements. Should any of these run <em>on the server</em> for added security or for some other reason? It doesn’t seem so.</p>
<p>Ok, so let’s flip our question around and ask, “Which of the remaining statements must run <em>on the client</em>?” It seems like it would be easiest if the while-loop that grabs and validates the player’s guess ran where the player sits. This means we’d mark lines 7-12 with a <code class="docutils literal notranslate"><span class="pre">C</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>   <span class="mi">1</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;## Welcome to GUESS THE NUMBER! ##&#39;</span><span class="p">)</span>
   <span class="mi">2</span>
<span class="n">S</span>  <span class="mi">3</span>  <span class="n">secret</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
   <span class="mi">4</span>
   <span class="mi">5</span>  <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># our game loop</span>
   <span class="mi">6</span>      
<span class="n">C</span>  <span class="mi">7</span>      <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="n">C</span>  <span class="mi">8</span>          <span class="k">try</span><span class="p">:</span>
<span class="n">C</span>  <span class="mi">9</span>              <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">))</span>
<span class="n">C</span> <span class="mi">10</span>              <span class="k">break</span>
<span class="n">C</span> <span class="mi">11</span>          <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="n">C</span> <span class="mi">12</span>              <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Guesses must be an integer. Try again...&#39;</span><span class="p">)</span>
  <span class="mi">13</span>
<span class="n">S</span> <span class="mi">14</span>      <span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">secret</span><span class="p">:</span>
<span class="n">S</span> <span class="mi">15</span>          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too small!&#39;</span><span class="p">)</span>
<span class="n">S</span> <span class="mi">16</span>      <span class="k">elif</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
<span class="n">S</span> <span class="mi">17</span>          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">)</span>
  <span class="mi">18</span>          <span class="k">break</span>
<span class="n">S</span> <span class="mi">19</span>      <span class="k">else</span><span class="p">:</span>
<span class="n">S</span> <span class="mi">20</span>          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too big!&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Wow, that’s most of our statements. We’re left with the <code class="docutils literal notranslate"><span class="pre">print</span></code> on line 1 and the <code class="docutils literal notranslate"><span class="pre">while</span></code> on line 5. It doesn’t seem like the server needs to be involved in the initial print statement (line 1). Servers react to clients, as we saw in the last chapter, and line 1 is setup to the actual game play.</p>
<p>So what about the loop that begins on line 5 (i.e., the game loop)? Let’s decide to run that loop on the client. This continues the view that servers react to clients, that they simply manage access to resources. Our resource is the secret number.</p>
<p>Here’s our final classification of statements across the client and server:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">C</span>  <span class="mi">1</span>  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;## Welcome to GUESS THE NUMBER! ##&#39;</span><span class="p">)</span>
   <span class="mi">2</span>
<span class="n">S</span>  <span class="mi">3</span>  <span class="n">secret</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
   <span class="mi">4</span>
<span class="n">C</span>  <span class="mi">5</span>  <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># our game loop</span>
   <span class="mi">6</span>      
<span class="n">C</span>  <span class="mi">7</span>      <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="n">C</span>  <span class="mi">8</span>          <span class="k">try</span><span class="p">:</span>
<span class="n">C</span>  <span class="mi">9</span>              <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">))</span>
<span class="n">C</span> <span class="mi">10</span>              <span class="k">break</span>
<span class="n">C</span> <span class="mi">11</span>          <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="n">C</span> <span class="mi">12</span>              <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Guesses must be an integer. Try again...&#39;</span><span class="p">)</span>
  <span class="mi">13</span>
<span class="n">S</span> <span class="mi">14</span>      <span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">secret</span><span class="p">:</span>
<span class="n">S</span> <span class="mi">15</span>          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too small!&#39;</span><span class="p">)</span>
<span class="n">S</span> <span class="mi">16</span>      <span class="k">elif</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
<span class="n">S</span> <span class="mi">17</span>          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">)</span>
<span class="n">C</span> <span class="mi">18</span>          <span class="k">break</span>
<span class="n">S</span> <span class="mi">19</span>      <span class="k">else</span><span class="p">:</span>
<span class="n">S</span> <span class="mi">20</span>          <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too big!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="its-sequence-diagram">
<p><strong>Its sequence diagram.</strong> Now that we have decomposed our game into a client portion and a separate server portion, we next have to determine: (1) the messages that will be sent back and forth; and (2) what Python libraries exist that will help us transmit and receive these messages (e.g., as the Python <code class="docutils literal notranslate"><span class="pre">requests</span></code> library did for our <code class="docutils literal notranslate"><span class="pre">qweb</span></code> examples).</p>
<p>In determining the messages we want sent, it helps to draw what’s called a <em>sequence diagram</em>. The executions of the client and server are shown in these diagrams as parallel, vertical lines, where time runs from the top to the bottom of the page. An event taking place at time <em>t1</em> in the client will generate a message that is sent to the server, and this message is shown as an arrow from the client to the server. Typically, we label these arrows with the content of the message. At a later time <em>t2</em>, the server might send a response message to the client. And so forth. Think of it as a conversation between two individuals.</p>
<p>Let’s build a sequence diagram for our simple guessing game based on the decomposition of functionality we just described between the client and server programs. In that decomposition, the first message we need to send is one from the client to the server, as illustrated in <a class="reference internal" href="#c05-fig1-ref"><span class="std std-numref">Figure 10</span></a>. It results from our decision to start the game loop in the client, where we capture the user’s first guess. The client, therefore, needs to share this guess with the server, and it sends a message to do so.</p>
<figure class="align-default" id="c05-fig1-ref">
<img alt="_images/Smith_fig_05-01.png" src="_images/Smith_fig_05-01.png" />
<figcaption>
<p><span class="caption-number">Fig. 10 </span><span class="caption-text">A sequence diagram for our simple guessing game.</span><a class="headerlink" href="#c05-fig1-ref" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
<p>The server would compare this guess against its secret number and respond with a message to the client that contains the appropriate one of three answers originally printed by <code class="docutils literal notranslate"><span class="pre">guess32.py</span></code>. Upon receipt of this server message, the client would print the message contents for the player. Notice that this description splits the print statements in <code class="docutils literal notranslate"><span class="pre">guess32.py</span></code> across the two scripts: the server generates what to print and the client does the actual printing.</p>
<p>Finally, unless the player guessed the secret number, the client grabs a new guess from the player, and the message loop begins again.</p>
</section>
<section id="when-to-use-a-new-library">
<p><strong>When to use a new library.</strong> We have a complete design for our networked game, and our next task is to start coding the client and server scripts. In this, we need to use a library that allows us to send messages between separately running applications. Can we use the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library, as we did in our last problem-to-be-solved?</p>
<p>When we previously used the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library, we didn’t think much about the network messages that were sent between the machine on which we ran our script and the server to which we were communicating. We simply specified a protocol (i.e., HTTP), the hostname of the server we wanted to contact, a path to a resource on that server (which we had to look up), and some parameters to help the server know what we wanted back.</p>
<p>It might help if you think of our use of the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library like a phone call to a business’s customer support line. This company publishes the number of its support line, and when we call it, we tell the company representative about the product we own and the questions we have. There’s a well-defined form to this conversation: ask a question; get a response.</p>
<p>When we choose to write both the client and server scripts, we might like to use a networking library that gives us more freedom in the form of the conversation that takes place. Instead of a call to a company’s customer support line, think about a call to a friend where one party might send a variable number of messages before the other party responds. The Python <code class="docutils literal notranslate"><span class="pre">socket</span></code> library gives us such freedom.</p>
<p>An important functional difference between our use of the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library and this new <code class="docutils literal notranslate"><span class="pre">socket</span></code> library is that the latter separates the act of sending a message from the act of receiving one, which provides us with the freedom to have a less-scripted conversation.<a class="footnote-reference brackets" href="#fn5" id="id5" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a> In fact, this separation of send and receive is exactly what a sequence diagram illustrates. We can draw multiple send lines from the client to the server before any response comes back from the server to the client.</p>
<p>Now, if you look at the structure of the conversation in our sequence diagram, you’ll notice that we don’t need this extra freedom. Should we use the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library for our guess-the-number application? Well, this leads us to another distinction between the two libraries. If we used the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library, we would have to write a server script that can parse HTTP messages, and if you look at what we wrote on the message lines in our sequence diagram, you’ll see that our messages are quite simple. We don’t need the complexity of HTTP messages. When we use the <code class="docutils literal notranslate"><span class="pre">socket</span></code> library, it makes no assumption about the form of the messages. To the <code class="docutils literal notranslate"><span class="pre">socket</span></code> library, our messages can be treated like short strings. This means that if we learn a little about this new networking library, we can send very simple text messages between our client and our server.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Python, like many programming languages, has lots of libraries with overlapping functionality. In problem solving, it is worth your time to find the right library for your task at hand.</p>
</div>
</section>
<section id="sockets-in-action">
<p><strong>Sockets in action.</strong> To understand the <code class="docutils literal notranslate"><span class="pre">socket</span></code> library, it helps to have the right image in your mind. The image we used with the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library was a verbal request. For the <code class="docutils literal notranslate"><span class="pre">socket</span></code> library, you should think of a thing, not an action, and the thing you should have in mind is an endpoint through which you can send and receive information, like a smartphone. As such, we need to create an abstract object in our script corresponding to this endpoint.</p>
<p>We will need one in both our client and server scripts (you can’t communicate through your phone to another person unless they have a phone too), but let’s start by focusing on the client. The following script grabs the statements from <code class="docutils literal notranslate"><span class="pre">guess32.py</span></code> that we marked as belonging in the client, and it inserts pseudocode corresponding to the messages in our sequence diagram.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">### chap05/guess-client-pseudocode.py</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="c1"># Addressing information for the server</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;## Welcome to GUESS THE NUMBER! ##&#39;</span><span class="p">)</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="c1"># Create a socket and call it s</span>
<span class="linenos"> 9</span>    <span class="c1"># Connect s to the server</span>
<span class="linenos">10</span>    
<span class="linenos">11</span>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># our game loop</span>
<span class="linenos">12</span>        <span class="c1"># Grab a guess from the player</span>
<span class="linenos">13</span>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">14</span>          <span class="k">try</span><span class="p">:</span>
<span class="linenos">15</span>              <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">))</span>
<span class="linenos">16</span>              <span class="k">break</span>
<span class="linenos">17</span>          <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="linenos">18</span>              <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Guesses must be an integer. Try again...&#39;</span><span class="p">)</span>
<span class="linenos">19</span>        
<span class="linenos">20</span>        <span class="c1"># Use s to send guess to server</span>
<span class="linenos">21</span>        <span class="c1"># Wait for server to respond on s with answer to comparison</span>
<span class="linenos">22</span>        <span class="c1"># Print response</span>
<span class="linenos">23</span>        
<span class="linenos">24</span>        <span class="c1"># Is game over?</span>
</pre></div>
</div>
<p>To think about what needs to happen as the script starts, it helps to think about what happens when we communicate using a smartphone. The comment about creating a socket object is equivalent to picking up our smartphone and selecting a communication app on it, like Messages on an iPhone where we can send text messages to another person. If we know how to reach this person (i.e., the addressing information in the pseudocode), then we can use this app (called <code class="docutils literal notranslate"><span class="pre">s</span></code> in the pseudocode) to send and receive messages.</p>
<p>The actual Python syntax we use to create a socket will remind you of the work we did in opening a file. Recall that we opened a file and gave a name to the object returned from the <code class="docutils literal notranslate"><span class="pre">open</span></code> command. We operated with that object for a while, and then we eventually told the system that we were done with it. The with-as-statement nicely bundled the open and close functionality into a single statement and an associated block within which the file was open. We’ll do the same with socket objects.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">### chap05/guess-client-noabstractions.py (INCOMPLETE)</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="c1"># Addressing information for the server</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 7</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;## Welcome to GUESS THE NUMBER! ##&#39;</span><span class="p">)</span>
<span class="linenos"> 8</span>    
<span class="linenos"> 9</span>    <span class="c1"># Create a socket and call it s</span>
<span class="linenos">10</span>    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="c1"># Connect s to the server</span>
<span class="linenos">12</span>        
<span class="linenos">13</span>        <span class="c1"># REST OF SCRIPT</span>
</pre></div>
</div>
<p>Just as we had to tell <code class="docutils literal notranslate"><span class="pre">open</span></code> some configuration parameters (e.g., are we opening a file for reading or writing?), we have to pass <code class="docutils literal notranslate"><span class="pre">socket.socket</span></code> some configuration parameters so that it creates for us a particular <code class="docutils literal notranslate"><span class="pre">socket</span></code> object. We won’t dive into the many different types of sockets that are possible. It is sufficient for us to know that the parameters in our partial script will create a socket that uses TCP/IPv4, which is a common protocol used for transporting messages around the Internet.<a class="footnote-reference brackets" href="#fn6" id="id6" role="doc-noteref"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></a> Using different parameters to create another kind of socket object is like choosing to use a different messaging app (e.g., Slack versus Message) in our smartphone analogy.</p>
</section>
<section id="specifying-the-other-party">
<p><strong>Specifying the other party.</strong> So far, we’ve selected the channel that we will use to communicate, and the next step is to specify to whom we want to communicate. A client script does this with a call to <code class="docutils literal notranslate"><span class="pre">socket.connect</span></code>, in which we specify a tuple consisting of a <em>hostname</em> (or the IP address corresponding to that hostname) and a <em>port</em> on that host.</p>
<p>It probably makes sense to you that we need to specify the name of the entity to which we want to communicate, but what need are we satisfying by specifying a port? Well, networked computers have a number of software ports, and this is like a friend that has multiple phone numbers. You can send a text message to this friend on any of their numbers, but you must pick one.<a class="footnote-reference brackets" href="#fn7" id="id7" role="doc-noteref"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></a></p>
<p>In computer networking, some port numbers have well-defined and widely agreed-upon uses. For example, HTTP uses port 80 to send and receive messages; HTTPS uses port 443; and the older File Transfer Protocol (FTP) uses ports 20 and 21. As another example, there are numerous ways to send email across the network: the Simple Mail Transfer Protocol (SMTP) uses port 25;  the Post Office Protocol 3 (POP3) uses port 110; and the Internet Message Access Protocol (IMAP4) uses port 143.</p>
<p>In the client script we’re building, we’re going to use a big number<a class="footnote-reference brackets" href="#fn8" id="id8" role="doc-noteref"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></a> for the port, which will place it far away from the port numbers used by the common services on our machine. We would rather not disrupt these important services with our messages.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">### chap05/guess-client-noabstractions.py (INCOMPLETE)</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>  <span class="c1"># The server&#39;s hostname or IP address</span>
<span class="linenos"> 5</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">65432</span>        <span class="c1"># The port used by the server</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 8</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;## Welcome to GUESS THE NUMBER! ##&#39;</span><span class="p">)</span>
<span class="linenos"> 9</span>    
<span class="linenos">10</span>    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="linenos">12</span>        
<span class="linenos">13</span>        <span class="c1"># REST OF SCRIPT</span>
</pre></div>
</div>
<p>Our script specifies the hostname (<code class="docutils literal notranslate"><span class="pre">HOST</span></code>) as an IP address. Every computer connected to the Internet has an IP address, and to get started with our client and server scripts, we’re going to use a special one. The IP address <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code> is recognized by most networked machines as a way of saying you’re talking about the machine on which you’re logged in, which in computer parlance is called the <em>localhost</em>. Just as each of us has a name, we also know we’re talking about ourselves when we say “self.”</p>
<p>You’ll also hear people talking about <code class="docutils literal notranslate"><span class="pre">127.0.0.1</span></code> as the <em>loopback address</em>. The idea is that we send out a message and it loops right back to us. By using this loopback address, we can run our client and server scripts on the same machine.</p>
</section>
<section id="sending-and-receiving-messages">
<p><strong>Sending and receiving messages.</strong> With a socket created and configured, we are ready to start sending and receiving messages. There are numerous different methods for sending and receiving messages in the <code class="docutils literal notranslate"><span class="pre">socket</span></code> library, and we’re going to use two fairly simple ones: <code class="docutils literal notranslate"><span class="pre">socket.sendall</span></code> and <code class="docutils literal notranslate"><span class="pre">socket.recv</span></code>.<a class="footnote-reference brackets" href="#fn9" id="id9" role="doc-noteref"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></a></p>
<p>Roughly speaking, <code class="docutils literal notranslate"><span class="pre">socket.sendall</span></code> takes the string we want to send and transmits it over the network, and <code class="docutils literal notranslate"><span class="pre">socket.recv</span></code> returns a message that was sent to us. But because the <code class="docutils literal notranslate"><span class="pre">socket</span></code> library is closer to the primitives in the machine than the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library, these functions ask us to specify the size of the buffers containing our messages and the character encodings used in these messages. So many details!</p>
<p>Perhaps you’re starting to see why the filename I’ve used in the opening comment of our current script is <code class="docutils literal notranslate"><span class="pre">guess-client-noabstractions.py</span></code>. In directly using the socket library, we have to deal with a lot of networking details that we mostly ignored in our use of the <code class="docutils literal notranslate"><span class="pre">requests</span></code> library. In a moment, we’ll start using our own <code class="docutils literal notranslate"><span class="pre">socket32</span></code> library, which is a <em>shim</em> between our script and the <code class="docutils literal notranslate"><span class="pre">socket</span></code> library. This shim library simplifies the <code class="docutils literal notranslate"><span class="pre">socket</span></code> API and creates easier-to-use abstractions for simple networking applications like ours.<a class="footnote-reference brackets" href="#fn10" id="id10" role="doc-noteref"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></a></p>
<p>While the following code block contains the entire “no abstractions” client script, the next two sections discuss two details needed by the <code class="docutils literal notranslate"><span class="pre">socket</span></code> library that that we’ll hide behind our <code class="docutils literal notranslate"><span class="pre">socket32</span></code> shim.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">### chap05/guess-client-noabstractions.py</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">socket</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>  <span class="c1"># The server&#39;s hostname or IP address</span>
<span class="linenos"> 5</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">65432</span>        <span class="c1"># The port used by the server</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 8</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;## Welcome to GUESS THE NUMBER! ##&#39;</span><span class="p">)</span>
<span class="linenos"> 9</span>    
<span class="linenos">10</span>    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="linenos">12</span>        
<span class="linenos">13</span>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># our game loop</span>
<span class="linenos">14</span>            <span class="c1"># Grab a guess from the player</span>
<span class="linenos">15</span>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">16</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">17</span>                    <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">))</span>
<span class="linenos">18</span>                    <span class="k">break</span>
<span class="linenos">19</span>                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="linenos">20</span>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Guesses must be an integer. Try again...&#39;</span><span class="p">)</span>
<span class="linenos">21</span>            
<span class="linenos">22</span>            <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="linenos">23</span>            <span class="n">response</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="linenos">24</span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="linenos">25</span>            
<span class="linenos">26</span>            <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">:</span>
<span class="linenos">27</span>                <span class="k">break</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">30</span>    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="size-matters">
<p><strong>Size matters.</strong> The first helpful abstraction in our <code class="docutils literal notranslate"><span class="pre">socket32</span></code> shim is to ignore message size. In the <code class="docutils literal notranslate"><span class="pre">socket</span></code> library, send and receive methods operate on network buffers, and these buffers are of a fixed size. This means that we need to pay attention to how the sizes of our messages interact with the fixed size of the network buffers.</p>
<p>In general, this is a messy problem that can result in some complicated code. You can read about some of the complicated situations in the Python documentation titled “Socket Programming HOWTO.”<a class="footnote-reference brackets" href="#fn11" id="id11" role="doc-noteref"><span class="fn-bracket">[</span>11<span class="fn-bracket">]</span></a> This is an important issue for a production piece of code to handle, but we ignore it inside our <code class="docutils literal notranslate"><span class="pre">socket32</span></code> shim since the messages in our current problem-to-be-solved are small in size and neither the client nor the server will send multiple messages before performing a receive.</p>
<p>Our <code class="docutils literal notranslate"><span class="pre">socket32</span></code> shim specifies that we’ll use a buffer size of <code class="docutils literal notranslate"><span class="pre">1024</span></code>, which is several times larger than the number of characters in our longest message. You can see this value as the parameter to the <code class="docutils literal notranslate"><span class="pre">recv</span></code> call in the code block above.<a class="footnote-reference brackets" href="#fn12" id="id12" role="doc-noteref"><span class="fn-bracket">[</span>12<span class="fn-bracket">]</span></a> <a class="reference internal" href="#c05-fig2-ref"><span class="std std-numref">Figure 11</span></a> illustrates how our <code class="docutils literal notranslate"><span class="pre">socket32</span></code> shim will hide the need to specify the receive buffer size when we write our <code class="docutils literal notranslate"><span class="pre">guess-client.py</span></code> script (coming below).</p>
<figure class="align-default" id="c05-fig2-ref">
<img alt="_images/Smith_fig_05-02.png" src="_images/Smith_fig_05-02.png" />
<figcaption>
<p><span class="caption-number">Fig. 11 </span><span class="caption-text">An illustration of how our <code class="docutils literal notranslate"><span class="pre">socket32.py</span></code> shim library slips between our client script and the Python <code class="docutils literal notranslate"><span class="pre">socket</span></code> library to simplify the interface on the networking functions we use.</span><a class="headerlink" href="#c05-fig2-ref" title="Permalink to this image">#</a></p>
</figcaption>
</figure>
</section>
<section id="encoding-again">
<p><strong>Encoding again!</strong> The second detail of the <code class="docutils literal notranslate"><span class="pre">sendall</span></code> and <code class="docutils literal notranslate"><span class="pre">recv</span></code> calls that we’ll abstract away deals with encoding. By having our client and the server use the same shim, we can guarantee that they speak the same language, or more precisely in the land of computation, they encode their string objects in the same way. We began worrying about this in Chapter 3, when we talked about the many ways the characters in a file might be encoded.</p>
<p>In some applications, clients and servers are written by different programmers. When this happens, we must know the character encoding that the server will use and force our strings into that encoding. This is the work being done by the <code class="docutils literal notranslate"><span class="pre">str.encode</span></code> and <code class="docutils literal notranslate"><span class="pre">str.decode</span></code> methods in the code block above. In particular, the script encodes into a Python <code class="docutils literal notranslate"><span class="pre">bytes</span></code> object, which is useful for holding and manipulating <em>binary data</em>. Binary data is a topic we’ll discuss soon, and for now, just think of this encoding work as transforming our string message into an agreed-upon encoding.</p>
</section>
<section id="a-simplified-networking-interface">
<p><strong>A simplified networking interface.</strong> At this point, you shouldn’t worry about understanding all the reasons why <code class="docutils literal notranslate"><span class="pre">sendall</span></code> and <code class="docutils literal notranslate"><span class="pre">recv</span></code> work the way that they do. Taking advantage of our shim library (in <code class="docutils literal notranslate"><span class="pre">socket32.py</span></code>), we can write a simpler client (<code class="docutils literal notranslate"><span class="pre">guess-client.py</span></code>). Carefully compare each statement in <code class="docutils literal notranslate"><span class="pre">guess-client.py</span></code> against its equivalent in <code class="docutils literal notranslate"><span class="pre">guess-client-noabstractions.py</span></code> and you’ll see what I mean by hiding details.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">### chap05/guess-client.py</span>
<span class="linenos"> 2</span><span class="kn">from</span> <span class="nn">socket32</span> <span class="kn">import</span> <span class="n">create_new_socket</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>  <span class="c1"># The server&#39;s hostname or IP address</span>
<span class="linenos"> 5</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">65432</span>        <span class="c1"># The port used by the server</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 8</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;## Welcome to GUESS THE NUMBER! ##&#39;</span><span class="p">)</span>
<span class="linenos"> 9</span>    
<span class="linenos">10</span>    <span class="k">with</span> <span class="n">create_new_socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos">11</span>        <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="linenos">12</span>        
<span class="linenos">13</span>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># our game loop</span>
<span class="linenos">14</span>            <span class="c1"># Grab a guess from the player</span>
<span class="linenos">15</span>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<span class="linenos">16</span>                <span class="k">try</span><span class="p">:</span>
<span class="linenos">17</span>                    <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Please input your guess: &#39;</span><span class="p">))</span>
<span class="linenos">18</span>                    <span class="k">break</span>
<span class="linenos">19</span>                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
<span class="linenos">20</span>                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Guesses must be an integer. Try again...&#39;</span><span class="p">)</span>
<span class="linenos">21</span>            
<span class="linenos">22</span>            <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">guess</span><span class="p">))</span>
<span class="linenos">23</span>            <span class="n">response</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="linenos">24</span>            <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="linenos">25</span>            
<span class="linenos">26</span>            <span class="k">if</span> <span class="n">response</span> <span class="o">==</span> <span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">:</span>
<span class="linenos">27</span>                <span class="k">break</span>
<span class="linenos">28</span>
<span class="linenos">29</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">30</span>    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>Given the simplified networking primitives, it is easier to see that we must, on line 22, convert the user’s integer guess into a string so that the client can send it in a message to the server. This type conversion is required because we’re sending strings, not integers in our messages!</p>
</section>
<section id="the-server">
<p><strong>The server.</strong> With our client complete, we can write pseudocode for the server script, taking the code parts of <code class="docutils literal notranslate"><span class="pre">guess32.py</span></code> we marked as belonging in the server. You’ll notice that the code block below pre-populates the server script with a call to create the server’s socket (line 8) and the address information the client uses to connect to the server (lines 5-6).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">### chap05/guess-server-pseudocode.py</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">socket32</span> <span class="kn">import</span> <span class="n">create_new_socket</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>  <span class="c1"># Standard loopback interface address (localhost)</span>
<span class="linenos"> 6</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">65432</span>  <span class="c1"># Port to listen on (non-privileged ports are &gt; 1023)</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">with</span> <span class="n">create_new_socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos"> 9</span>    <span class="c1"># Bind socket to address and publish contact info</span>
<span class="linenos">10</span>    
<span class="linenos">11</span>    <span class="c1"># Answer incoming connection</span>
<span class="linenos">12</span>    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connected by &lt;client&gt;&#39;</span><span class="p">)</span>
<span class="linenos">13</span>    
<span class="linenos">14</span>    <span class="c1"># Create a secret for this connection    </span>
<span class="linenos">15</span>    <span class="n">secret</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="linenos">16</span>    
<span class="linenos">17</span>    <span class="c1"># Send and receive messages through the connection</span>
<span class="linenos">18</span>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># message processing loop</span>
<span class="linenos">19</span>        <span class="n">msg</span> <span class="o">=</span> <span class="c1"># recv guess from client</span>
<span class="linenos">20</span>        <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">21</span>        
<span class="linenos">22</span>        <span class="c1"># Check guess against secret and respond</span>
<span class="linenos">23</span>        <span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">24</span>            <span class="c1"># sendall(&#39;Too small!&#39;)</span>
<span class="linenos">25</span>        <span class="k">elif</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">26</span>            <span class="c1"># sendall(&#39;Exactly! You win!&#39;)</span>
<span class="linenos">27</span>        <span class="k">else</span><span class="p">:</span>
<span class="linenos">28</span>            <span class="c1"># sendall(&#39;Too big!&#39;)</span>
<span class="linenos">29</span>    
<span class="linenos">30</span>    <span class="c1"># If we get here, client broke connection</span>
</pre></div>
</div>
</section>
<section id="a-connection">
<p><strong>A connection.</strong> Inside the body of the with-statement, you’ll notice that this script doesn’t just create a socket. It introduces the idea of a <em>connection</em>. To understand this, we need to move away from our image of two people texting and think about a phone call. In a phone call, there’s an open line between the two parties for the entire length of the call. Even when both parties are silent (i.e., no one is sending a message), the phone line keeps the two parties connected. This is how a server works with messages sent to its sockets.</p>
<p>Let’s see how we create such a connection. The next code block turns the pseudocode on line 9 of the previous code block into Python. It takes the socket the server created and manipulates it so that a client can message the server on this socket. In particular, the server script must <code class="docutils literal notranslate"><span class="pre">bind</span></code> the socket object to a host and port (line 11 below). This is equivalent to associating a cell phone (i.e., the socket) with a particular phone number (i.e., the host and port).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">### chap05/guess-server.py (INCOMPLETE)</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">socket32</span> <span class="kn">import</span> <span class="n">create_new_socket</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>  <span class="c1"># Standard loopback interface address (localhost)</span>
<span class="linenos"> 6</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">65432</span>  <span class="c1"># Port to listen on (non-privileged ports are &gt; 1023)</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 9</span>    <span class="k">with</span> <span class="n">create_new_socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos">10</span>        <span class="c1"># Bind socket to address and publish contact info</span>
<span class="linenos">11</span>        <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="linenos">12</span>        <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>
<span class="linenos">13</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GUESS-THE-NUMBER server started. Listening on&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="linenos">14</span>        
<span class="linenos">15</span>        <span class="c1"># REST OF SCRIPT</span>
</pre></div>
</div>
<p>To receive phone calls on that phone, we also must publish the phone number, which lets people know we’ll answer it if they call it. This is the purpose of <code class="docutils literal notranslate"><span class="pre">listen</span></code> method (line 12 above), which we will always group with the call to <code class="docutils literal notranslate"><span class="pre">bind</span></code>.</p>
</section>
<section id="picking-up-a-call">
<p><strong>Picking up a call.</strong> With that configuration complete, the server can now await a <code class="docutils literal notranslate"><span class="pre">socket.connect</span></code> call from a client. The server does this with a call to <code class="docutils literal notranslate"><span class="pre">socket.accept</span></code> (line 16), which blocks the server script until the operating system notifies it that some client has asked for a connection. When this happens, the <code class="docutils literal notranslate"><span class="pre">accept</span></code> method returns a tuple consisting of a new <code class="docutils literal notranslate"><span class="pre">socket</span></code> object (<code class="docutils literal notranslate"><span class="pre">conn2client</span></code>) and an address tuple. This address tuple contains the client’s address information, which is in the form of host and port. The address information is like caller-id on your phone!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 6</span><span class="c1">### chap05/guess-server.py (INCOMPLETE)</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 9</span>    <span class="k">with</span> <span class="n">create_new_socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos">10</span>        <span class="c1"># Bind socket to address and publish contact info</span>
<span class="linenos">11</span>        <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="linenos">12</span>        <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>
<span class="linenos">13</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GUESS-THE-NUMBER server started. Listening on&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="linenos">14</span>        
<span class="linenos">15</span>        <span class="c1"># Answer incoming connection</span>
<span class="linenos">16</span>        <span class="n">conn2client</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
<span class="linenos">17</span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connected by&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
<span class="linenos">18</span>        
<span class="linenos">19</span>        <span class="c1"># REST OF SCRIPT</span>
</pre></div>
</div>
</section>
<section id="the-conversation">
<p><strong>The conversation.</strong> The returned socket (<code class="docutils literal notranslate"><span class="pre">conn2client</span></code>) is the one that the server will use to communicate with the client. By creating a new socket for each accepted connection, the server can serve multiple clients simultaneously. The original socket (i.e., <code class="docutils literal notranslate"><span class="pre">s</span></code> in our script) is how all clients reach the server to request a connection. When the server accepts a client’s connection, it converses with it through a separate socket (our <code class="docutils literal notranslate"><span class="pre">conn2client</span></code>), which is dedicated to that client’s conversation. This separation of tasks is a very powerful problem-solving technique!</p>
<p>In our completed server script, we’ll operate on this new socket inside a with-statement (line 19) so that it is properly closed when the server is done with it.<a class="footnote-reference brackets" href="#fn13" id="id13" role="doc-noteref"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></a> Inside this with-statement’s body, we generate a secret for this client connection and slip into an infinite loop, in which the server waits for the client to send a message containing a guess.<a class="footnote-reference brackets" href="#fn14" id="id14" role="doc-noteref"><span class="fn-bracket">[</span>14<span class="fn-bracket">]</span></a> Once received, the server compares the guess against its secret. Depending on the result of this comparison, the server sends an appropriate response using <code class="docutils literal notranslate"><span class="pre">conn2client.sendall</span></code>. It then awaits the next guess.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="c1">### chap05/guess-server.py</span>
<span class="linenos"> 2</span><span class="kn">import</span> <span class="nn">random</span>
<span class="linenos"> 3</span><span class="kn">from</span> <span class="nn">socket32</span> <span class="kn">import</span> <span class="n">create_new_socket</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>  <span class="c1"># Standard loopback interface address (localhost)</span>
<span class="linenos"> 6</span><span class="n">PORT</span> <span class="o">=</span> <span class="mi">65432</span>  <span class="c1"># Port to listen on (non-privileged ports are &gt; 1023)</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
<span class="linenos"> 9</span>    <span class="k">with</span> <span class="n">create_new_socket</span><span class="p">()</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
<span class="linenos">10</span>        <span class="c1"># Bind socket to address and publish contact info</span>
<span class="linenos">11</span>        <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
<span class="linenos">12</span>        <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">()</span>
<span class="linenos">13</span>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GUESS-THE-NUMBER server started. Listening on&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span>
<span class="linenos">14</span>        
<span class="linenos">15</span>        <span class="c1"># Answer incoming connection</span>
<span class="linenos">16</span>        <span class="n">conn2client</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
<span class="linenos">17</span>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Connected by&#39;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
<span class="linenos">18</span>        
<span class="linenos">19</span>        <span class="k">with</span> <span class="n">conn2client</span><span class="p">:</span>
<span class="linenos">20</span>            <span class="c1"># Create a secret for this connection    </span>
<span class="linenos">21</span>            <span class="n">secret</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="linenos">22</span>            
<span class="linenos">23</span>            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>   <span class="c1"># message processing loop</span>
<span class="linenos">24</span>                <span class="n">msg</span> <span class="o">=</span> <span class="n">conn2client</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
<span class="linenos">25</span>                <span class="k">if</span> <span class="n">msg</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
<span class="linenos">26</span>                    <span class="k">break</span>
<span class="linenos">27</span>                <span class="n">guess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
<span class="linenos">28</span>                
<span class="linenos">29</span>                <span class="c1"># Check guess against secret and respond</span>
<span class="linenos">30</span>                <span class="k">if</span> <span class="n">guess</span> <span class="o">&lt;</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">31</span>                    <span class="n">conn2client</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s1">&#39;Too small!&#39;</span><span class="p">)</span>
<span class="linenos">32</span>                <span class="k">elif</span> <span class="n">guess</span> <span class="o">==</span> <span class="n">secret</span><span class="p">:</span>
<span class="linenos">33</span>                    <span class="n">conn2client</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s1">&#39;Exactly! You win!&#39;</span><span class="p">)</span>
<span class="linenos">34</span>                <span class="k">else</span><span class="p">:</span>
<span class="linenos">35</span>                    <span class="n">conn2client</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="s1">&#39;Too big!&#39;</span><span class="p">)</span>
<span class="linenos">36</span>            
<span class="linenos">37</span>            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Disconnected&#39;</span><span class="p">)</span>
<span class="linenos">38</span>
<span class="linenos">39</span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="linenos">40</span>    <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>When is the server done with the <code class="docutils literal notranslate"><span class="pre">conn2client</span></code> socket? You might think that the server can sever the connection once the client guesses the secret number (i.e., at line 33), but that would lead to a networking problem.<a class="footnote-reference brackets" href="#fn15" id="id15" role="doc-noteref"><span class="fn-bracket">[</span>15<span class="fn-bracket">]</span></a> Stay true to the server-managing-a-resource imagery and have the server wait until the client disconnects, as I describe next.</p>
</section>
<section id="programmer-beware">
<p><strong>Programmer beware.</strong> The steps we took to establish a connection between the client and server can fail in many ways, and if we were writing production scripts, we’d want to write them to catch and gracefully handle all these errors. When we bypass this important work and assume everything proceeds smoothly, our server script needs to handle only one networking condition: client disconnects.</p>
<p>The if-statement on line 25 is the code that recognizes when the client disconnects. It doesn’t look like it does this, but here’s how it works: This if-statement checks the value of <code class="docutils literal notranslate"><span class="pre">guess</span></code> from the <code class="docutils literal notranslate"><span class="pre">recv</span></code> method call, and if this value is the empty string, it breaks us out of the infinite loop. It doesn’t matter whether the client finished its work (i.e., terminated cleanly) or it terminated prematurely. The networking protocol running below the socket library’s API knows when the client breaks the connection, and it alerts the server’s operating system (OS). The OS then unblocks the server’s <code class="docutils literal notranslate"><span class="pre">recv</span></code> call, and since there was no client message, the returned result of the <code class="docutils literal notranslate"><span class="pre">recv</span></code> is the empty string. Our script sees this empty string and knows that the client has terminated.</p>
<p>You might feel that there is a lot of networking setup for the server in our simple application. While there’s more than in the client, this setup supports the generation of very powerful servers that converse with many clients simultaneously. In fact, you use such servers every day! As you try your own version of a networked game, your server script should copy lines 9-19 and 23-26 unchanged. You can change the name used for the result of the <code class="docutils literal notranslate"><span class="pre">conn2client.recv()</span></code> call on lines 24-25, but don’t change the order of the networking calls or move this cryptic if-statement. Networking is a complicated and tricky subject. Our goal in this chapter and its exercises is understand the basics of network programming and play with the power of it without digging into the complexities.</p>
</section>
<section id="run-it">
<p><strong>Run it!</strong> Are you ready to try running our client and server scripts? It’s a bit more complicated than running a single script but not terribly much. If you’re running with an IDE, follow either the first or second option below:</p>
<ul class="simple">
<li><p>IDE Option 1: The simplest (and my recommended) approach is to run the Python interpreter on the server and client scripts using two different shell windows. Start the server script in one shell <em>before</em> the client script in the other. When the client script terminates, the server script should automatically terminate too.</p></li>
<li><p>IDE Option 2: If you are comfortable with a Unix-like command line interface, you can use one shell window and start the server script in background (i.e., by appending an ampersand to the command). Then run the client script. It would look something like following transcript. Line 2 is the <em>job number</em> and <em>process ID</em> given to the running <code class="docutils literal notranslate"><span class="pre">guess-server</span></code> by the shell; yours will be different. Line 3 is the shell giving us the next prompt mashed together with the status print I included in the server script; the shell and the server are both writing to the terminal. You could type <code class="docutils literal notranslate"><span class="pre">python3</span> <span class="pre">guess-client.py</span></code> right on line 4, but I hit return to get an unobscured shell prompt and then start the client. The client is now running, but so is the server, and both of these processes write something to the terminal.<a class="footnote-reference brackets" href="#fn16" id="id16" role="doc-noteref"><span class="fn-bracket">[</span>16<span class="fn-bracket">]</span></a> Since our code to grab a player’s guess is resilient, I again hit return to get a clean prompt from the client. You can now see why I recommend Option 1, which gives the server and client their own terminal windows in which they output text.</p></li>
</ul>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>chap05$ python3 guess-server.py &amp;
<span class="linenos"> 2</span>[1] 10440
<span class="linenos"> 3</span>chap05$ GUESS-THE-NUMBER server started. Listening on (&#39;127.0.0.1&#39;, 65432)
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>chap05$ python3 guess-client.py 
<span class="linenos"> 6</span>## Welcome to GUESS THE NUMBER! ##
<span class="linenos"> 7</span>Please input your guess: Connected by (&#39;127.0.0.1&#39;, 51049)
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>Guesses must be an integer. Try again...
<span class="linenos">10</span>Please input your guess:
</pre></div>
</div>
<p>If you’re running this chapter’s scripts as code blocks in an interactive Python notebook, you’ll want to use the magic of the exclamation-point escape and the Unix <code class="docutils literal notranslate"><span class="pre">nohup</span></code> command.<a class="footnote-reference brackets" href="#fn17" id="id17" role="doc-noteref"><span class="fn-bracket">[</span>17<span class="fn-bracket">]</span></a> Here’s what you do:</p>
<ol class="arabic simple">
<li><p>Upload <code class="docutils literal notranslate"><span class="pre">guess-server.py</span></code> and <code class="docutils literal notranslate"><span class="pre">socket32.py</span></code> into your notebook session.</p></li>
<li><p>Create a code block like the one below and run it. It’ll start <code class="docutils literal notranslate"><span class="pre">guess-server.py</span></code> in background. An exclamation point (<code class="docutils literal notranslate"><span class="pre">!</span></code>) in the first column of a code block tells the Python interpreter to pass the rest of the line to the shell.</p></li>
<li><p>Finally, copy the <code class="docutils literal notranslate"><span class="pre">main</span></code> function from <code class="docutils literal notranslate"><span class="pre">guess-client.py</span></code> into a code block and run it. You’ve effectively done what I called “IDE Option 2” above but inside an interactive Python notebook. Since separate code blocks don’t share where they put their output, you won’t see the interleaving mess I described above.</p></li>
</ol>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>!nohup python3 guess-server.py &amp;
</pre></div>
</div>
<p>In each of these approaches, we’re not really using the network. Remember that we’re running these two scripts with the loopback interface, but we can’t easily tell that without looking at the code. Again, abstraction at work!</p>
<hr class="footnotes docutils" />
<aside class="footnote brackets" id="fn1" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id1">1</a><span class="fn-bracket">]</span></span>
<p>Using randomly generated numbers is only one type of nondeterminism. Working with networked programs will introduce you to another type, and the techniques in this chapter will help you handle both forms.</p>
</aside>
<aside class="footnote brackets" id="fn2" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id2">2</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://docs.python.org/3/library/random.html">https://docs.python.org/3/library/random.html</a></p>
</aside>
<aside class="footnote brackets" id="fn3" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id3">3</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://docs.python.org/3/library/functions.html#input">https://docs.python.org/3/library/functions.html#input</a></p>
</aside>
<aside class="footnote brackets" id="fn4" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id4">4</a><span class="fn-bracket">]</span></span>
<p>Think about what it takes to check if a string is an integer. We need to visit and check each character, verifying that it is a number. Except that we probably don’t want leading zeros. And except that we should allow for a leading `+` or `-` character, which may or may not be there. This is tricky code to write correctly, and why should we bother? Someone already did this work in `int`!</p>
</aside>
<aside class="footnote brackets" id="fn5" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id5">5</a><span class="fn-bracket">]</span></span>
<p>In case you’re curious, the `socket` library is similar to the networking primitives in most operating systems. The `requests` library, in fact, uses the `socket` library in its implementation!</p>
</aside>
<aside class="footnote brackets" id="fn6" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id6">6</a><span class="fn-bracket">]</span></span>
<p>There are many resources available on the Internet where you can learn about the TCP/IPv4 protocol. You won’t need to know any details to code and run our scripts.</p>
</aside>
<aside class="footnote brackets" id="fn7" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id7">7</a><span class="fn-bracket">]</span></span>
<p>Although the text talks about a friend with multiple cell phones, the ports I’m talking about are not the hardware ports that you can find, for example, on the side of your laptop. Software ports are a way to separate the stream of messages coming in on your laptop’s network connection into several different logical streams. It’s like what you probably do when you separate your real mail from your junk mail.</p>
</aside>
<aside class="footnote brackets" id="fn8" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id8">8</a><span class="fn-bracket">]</span></span>
<p>You can have at most 65,536 ports, and so our “big number” will be somewhere close to the upper limit.</p>
</aside>
<aside class="footnote brackets" id="fn9" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id9">9</a><span class="fn-bracket">]</span></span>
<p>Both these methods are blocking calls, e.g., `socket.sendall` blocks until the entire message is sent (or an error occurs). For short messages in an application like ours, where the server serves only one client, this is a reasonable thing to do.</p>
</aside>
<aside class="footnote brackets" id="fn10" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id10">10</a><span class="fn-bracket">]</span></span>
<p>While we use a shim to simplify the interface to a library with more functionality than we need, shim libraries solve numerous software engineering problems. For example, you could use a shim library to keep an application running while the software libraries on which it depends are slowly upgraded. The shim translates between the new and old versions of an API. You can think of this as keeping a plane aloft while you sequentially upgrade each of its systems.</p>
</aside>
<aside class="footnote brackets" id="fn11" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id11">11</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://docs.python.org/3/howto/sockets.html#socket-howto">https://docs.python.org/3/howto/sockets.html#socket-howto</a></p>
</aside>
<aside class="footnote brackets" id="fn12" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id12">12</a><span class="fn-bracket">]</span></span>
<p>It’s not always possible to know the maximum size of the messages that will be sent nor be able to allocate a buffer as large as your application’s largest message size, assuming it is known. As you can imagine in these instances, you’d have to turn a simple receive call into a loop of receive calls.</p>
</aside>
<aside class="footnote brackets" id="fn13" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id13">13</a><span class="fn-bracket">]</span></span>
<p>There is no as-clause in the with-statement on line 19 because we previously created and named the object whose lifetime ends when the with-block is exited.</p>
</aside>
<aside class="footnote brackets" id="fn14" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id14">14</a><span class="fn-bracket">]</span></span>
<p>Line 24 of `guess-server.py` names the object returned from `conn2client.recv` call `msg`. This object is a string, and if it is the empty string, the server knows that the client has hung up and it ends the message processing loop. If the message isn’t the empty string, the server converts the message, which should be a string in an integer suit in this game, into an integer to compare it against the secret number. In other server scripts, line 27 might be more complicated depending on the message structure.</p>
</aside>
<aside class="footnote brackets" id="fn15" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id15">15</a><span class="fn-bracket">]</span></span>
<p>If the server breaks the connection before the client, the connection won’t be shut down properly and you’ll have to wait for the operating system to timeout a bunch of networking resources. No big deal, but it is annoying when you can’t immediately run your next test.</p>
</aside>
<aside class="footnote brackets" id="fn16" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id16">16</a><span class="fn-bracket">]</span></span>
<p>The interleaving of the output that you see might look different since we cannot predict the way a machine will run two independent processes. Our machines are constantly running a small part of one program and then switching to run a small part of another, which makes it look like the machine is running them all at the same time—look up <em>timesharing</em> to learn more. To avoid this unpredictability, I carefully constructed the sequence diagram for this game to have the client and server alternate in sending messages (i.e., there’s never any confusion about which should be talking and which should be listening).</p>
</aside>
<aside class="footnote brackets" id="fn17" role="note">
<span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#id17">17</a><span class="fn-bracket">]</span></span>
<p>The `nohup` command is an infrequently used command that stands for “no hang up.” Hang up is a term that Unix-like systems use to indicate that the user has logged out. At logout, all a user’s running programs are sent a hangup (HUP) signal, and typically programs end when they receive it. The `nohup` command says to ignore the HUP signal. The combination of `nohup` with a script launched in the background guarantees that the command won’t block us from running other code cells.</p>
</aside>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="chap04.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Chapter 4: Query a Web Resource</p>
      </div>
    </a>
    <a class="right-next"
       href="chap06.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Chapter 6: Do You See My Dog?</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#guessing-a-number">Guessing a number</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-player-s-guess">The player’s guess</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#type-conversion">Type conversion</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#try-and-recover">Try and recover</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-game-loop">The game loop</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#testing-our-proposed-solution">Testing our proposed solution</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-networked-architecture">A networked architecture</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#its-sequence-diagram">Its sequence diagram</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#when-to-use-a-new-library">When to use a new library</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sockets-in-action">Sockets in action</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#specifying-the-other-party">Specifying the other party</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sending-and-receiving-messages">Sending and receiving messages</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#size-matters">Size matters</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#encoding-again">Encoding again!</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-simplified-networking-interface">A simplified networking interface</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-server">The server</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-connection">A connection</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#picking-up-a-call">Picking up a call</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-conversation">The conversation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#programmer-beware">Programmer beware</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run-it">Run it!</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Mike Smith
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023 by Michael D. Smith. All rights reserved.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>